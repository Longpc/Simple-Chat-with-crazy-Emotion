var emotions =  [
				 {syntax: '(devil)',title: 'Devil',icon: '1.gif'},
				 {syntax: ':((',title: 'Crying',icon: '2.gif'},
				 {syntax: ';;)',title: 'batting eyelashes',icon: '3.gif'},
				 {syntax: '(hug)',title: 'big hug',icon: '4.gif'},
				 {syntax: '(cowboy)',title: 'cowboy',icon: '5.gif'},
				 {syntax: ':D',title: 'big grin',icon: '6.gif'},
				 {syntax: ':-/',title: 'confused',icon: '7.gif'},
				 {syntax: ':x',title: 'love struck',icon: '8.gif'},
				 {syntax: '(leuleu)',title: 'leuleu',icon: '10.gif'},
				 {syntax: ':-*',title: 'kiss',icon: '11.gif'},
				 {syntax: '(kiss)',title: 'kiss',icon: '11.gif'},
				 {syntax: '=((',title: 'broken heart',icon: '12.gif'},
				 {syntax: ':-O',title: 'surprise',icon: '13.gif'},
				 {syntax: ':o',title: 'surprise',icon: '13.gif'},
				 {syntax: '~X(',title: 'at wits\' end',icon: '14.gif'},
				 {syntax: '(uhmhu)',title: 'uhmhu',icon: '15.gif'},
				 {syntax: 'B-)',title: 'cool',icon: '16.gif'},
				 {syntax: '(sohai)',title: 'sohai',icon: '17.gif'},
				 {syntax: '(whew)',title: 'whew!',icon: '18.gif'},
				 {syntax: ':))',title: 'laughing',icon: '19.gif'},
				 {syntax: ':(',title: 'sad',icon: '20.gif'},
				 {syntax: '(vln)',title: 'vln',icon:'21.gif'},
				 {syntax: '(:|',title: 'yawn',icon: '22.gif'},
				 {syntax: '(phone)',title: 'on the phone',icon: '23.gif'},
				 {syntax: '=))',title: 'rolling on the floor',icon: '24.gif'},
				 {syntax: 'O:-)',title: 'angel',icon: '25.gif'},
				 {syntax: ':-B',title: 'nerd',icon: '26.gif'},
				 {syntax: '=;',title: 'talk to the hand',icon: '27.gif'},
				 {syntax: '@@',title: 'rolling eyes',icon: '29.gif'},
				 {syntax: 'L-)',title: 'loser',icon: '30.gif'},
				 {syntax: '(sick)',title: 'sick',icon: '31.gif'},
				 {syntax: ':-$',title: 'don\'t tell anyone',icon: '32.gif'},
				 {syntax: '(nono)',title: 'nono',icon: '33.gif'},
				 {syntax: ':O)',title: 'clown',icon: '34.gif'},
				 {syntax: '8-}',title: 'silly',icon: '35.gif'},
				 {syntax: '(party)',title: 'party',icon: '36.gif'},
				 {syntax: ':|',title: 'straight face',icon: '37.gif'},
				 {syntax: '=P~',title: 'drooling',icon: '38.gif'},
				 {syntax: ':-?',title: 'thinking',icon: '39.gif'},
				 {syntax: '(oh)',title: 'd\'oh',icon: '40.gif'},
				 {syntax: '=D&gt;',title: 'applause',icon: '41.gif'},
				 {syntax: ':-S',title: 'worried',icon: '42.gif'},
				 {syntax: '@-)',title: 'hypnotized',icon: '43.gif'},
				 {syntax: ':^o',title: 'liar',icon: '44.gif'},
				 {syntax: '(wait)',title: 'wait',icon: '45.gif'},
				 {syntax: '(thodai)',title: 'thodai',icon: '46.gif'},
				 {syntax: ':P',title: 'tongue',icon: '47.gif'},
				 {syntax: ';)',title: 'winking',icon: '48.gif'},
				 {syntax: ':)',title: 'happy',icon: '100.gif'},
				 {syntax: ':-c',title: 'call me',icon: '101.gif'},
				 {syntax: '(angry)',title: 'angry',icon: '102.gif'},
				 {syntax: '(bye)',title: 'wave',icon: '103.gif'},
				 {syntax: '(mongmo)',title: 'mongmo',icon: '105.gif'},
				 {syntax: '(bow)',title: 'bow',icon: 'emo_bow.gif'},
				 {syntax: '(clap)',title: 'clap',icon: 'emo_clap.gif'},
				 {syntax: '(dance)',title: 'dance',icon: 'emo_dance.gif'},
				 {syntax: '(:/)',title: '(:/)',icon: 'emo_komanechi.gif'},
				 {syntax: '(muscle)',title: 'muscle',icon: 'emo_muscle.gif'},
				 {syntax: '(roger)',title: 'roger',icon: 'emo_roger.gif'},
				 {syntax: '(yes)',title: 'yes',icon: 'emo_yes.gif'},
				 {syntax: '(y)',title: 'y',icon: 'emo_yes.gif'},
				 {syntax: '(dkm)',title: 'dkm',icon: 'dkm.gif'},
				 {syntax: '(dislike)',title: 'dislike',icon: 'dislike.jpg'},
				 {syntax: '(nguamat)',title: 'nguamat',icon: 'nguamat.jpg'},
				 {syntax: '(stop)',title: 'stop',icon: 'stop.jpeg'},
				 {syntax: '(sepoku)',title: 'sepoku',icon: 'sepoku.jpg'},
				 {syntax: '(lol)',title: 'lol',icon: 'lol.png'},
				 {syntax: '(senpai)',title: 'senpai',icon: 'senpai.jpg'},
				 {syntax: '(duma)',title: 'duma',icon: 'duma.jpg'},
				 {syntax: '(tanei)',title: 'tanei',icon: 'tanei.jpg'},
				 {syntax: '(tanei1)',title: 'tanei',icon: 'tanei1.jpg'},
				 {syntax: '(matsu)',title: 'matsu',icon: 'matsu.jpg'},
				 {syntax: '(vavomom)',title: 'vavomom',icon: 'vavamom.jpg'},
				 {syntax: '(vavomom2)',title: 'vavomom2',icon: 'vavomom2.jpg'},
				 {syntax: '(chemgio)',title: 'chemgio',icon: 'chemgio.jpg'},
				 {syntax: '(binhtinh)',title: 'binhtinh',icon: 'binhtinh.jpg'},
				 {syntax: '(thata)',title: 'thata',icon: 'thata.jpg'},
				 {syntax: '(dungdua)',title: 'dunggua',icon: 'dungdua.jpg'},
				 {syntax: '(du)',title: 'du',icon: 'du.jpg'},
				 {syntax: '(neuchumuon)',title: 'neuchumuon',icon: 'neuchumuon.jpg'},
				 {syntax: '(yaoming)',title: 'yaoming',icon: 'yaoming.png'},
				 {syntax: '(nene)',title: 'nene',icon: 'nene.png'},
				 {syntax: '(fa)',title: 'fa',icon: 'foreveralone.png'},
				 {syntax: '(dmdm)',title: 'dmdm',icon: 'dmdm.jpg'},
				 {syntax: '(oidm)',title: 'oidm',icon: 'oidm.jpg'},
				 {syntax: '(oivl)',title: 'oivl',icon: 'oivl.gif'},
				 {syntax: '(antat)',title: 'antat',icon: 'antat.gif'},
				 {syntax: '(aaa)',title: 'aaa',icon: 'khocthet.gif'},
				 {syntax: '(notbad)',title: 'notbad',icon: 'notbad.png'},
				 {syntax: '(suyngam)',title: 'suyngam',icon: 'abc.png'},
				 {syntax: ':v',title: 'haha',icon: 'fbv.png'},
				 {syntax: ':3',title: 'humm',icon: 'fb3.png'},
				 {syntax: '^_^',title: 'hihi',icon: 'fb4.png'},
				 {syntax: '(wtf)',title: 'wtf',icon: 'wtf.jpg'},
				 {syntax: '(hobao)',title: 'hobao',icon: 'hobao.jpg'},
				 {syntax: '(sontung)',title: 'sontung',icon: 'sontung.jpg'},
				 {syntax: '(-->)',title: '-->',icon: 'test1.jpg'},
				 {syntax: '(why)',title: 'why',icon: 'why.png'},
				 {syntax: '(khocthet)',title: 'khocthet',icon: 'images.jpg'},
				 {syntax: '(hihihi)',title: 'hihihi',icon: 'test2.jpg'},
				 {syntax: '(hjxhjx)',title: 'hjxhjx',icon: 'test3.jpg'},
				 {syntax: '(fuck)',title: 'fuck',icon: 'test4.jpg'},
				 {syntax: '(themvc)',title: 'themvc',icon: 'test5.jpg'},
				 {syntax: '(test6)',title: 'test6',icon: 'test6.jpg'},
				 {syntax: '(test7)',title: 'test7',icon: 'test7.jpg'},
				 {syntax: '(test8)',title: 'test8',icon: 'test8.png'},
				 {syntax: '(test9)',title: 'test9',icon: 'test9.jpg'},
				 {syntax: '(fap)',title: 'fap',icon: 'fap.jpg'},
				 {syntax: '(layvo)',title: 'layvo',icon: 'layvo.jpg'},
				 {syntax: '(uoi)',title: 'uoi',icon: 'uoi.jpg'},
				 {syntax: '(tatmay)',title: 'tatmay',icon: 'tatmay.jpg'},
				 {syntax: '(gheanha)',title: 'gheanha',icon: 'gheanha.jpg'},
				 {syntax: '(daudau)',title: 'daudau',icon: 'daudau.jpg'},
				 {syntax: '(danglong)',title: 'danglong',icon: 'danglong.png'},
				 {syntax: '(saochude)',title: 'saochude',icon: 'saochude.jpg'},
				 {syntax: '(fuk)',title: 'fuk',icon: 'taythoi.jpg'},
				 {syntax: '(ajingon)',title: 'ajingon',icon: 'ajingon.jpg'},
				 {syntax: '(nghiemtuc)',title: 'nghiemtuc',icon: 'nghiemtuc.jpg'},
				 {syntax: '(liemmanhinh)',title: 'liemmanhinh',icon: 'liemmanhinh.jpg'},
				 {syntax: '(laythanh)',title: 'laythanh',icon: 'laythanh.jpg'},
				 {syntax: '(gaune)',title: 'gaune',icon: 'gaune.jpg'},
				 {syntax: '(haha)',title: 'haha',icon: 'haha.jpg'},
				 {syntax: '(like)',title: 'like',icon: 'like.jpg'},
				 {syntax: '(hayvc)',title: 'hayvc',icon: 'hayvc.jpg'},
				 {syntax: '(tangai)',title: 'tangai',icon: 'tangai.jpg'},
				 {syntax: '(oigai)',title: 'oigai',icon: 'oigai.jpg'},
				 {syntax: '(deocogi)',title: 'deocogi',icon: 'deocogi.jpg'},
				 {syntax: '(kinhbome)',title: 'kinhbome',icon: 'kinhbome.jpg'},
				 {syntax: '(nhinphe)',title: 'nhinphe',icon: 'nhinphe.jpg'},
				 {syntax: '(coly)',title: 'coly',icon: 'coly.jpg'},
				 {syntax: '(loitaichua)',title: 'loitaichua',icon: 'loitaichua.jpg'},
				 {syntax: '(thatkothetinnoi)',title: 'thatkothetinnoi',icon: 'thatkothetinnoi.jpg'}
			];
var app = angular.module("MyApp", ["ui.bootstrap.modal"]);

app.controller("MyCtr", function($scope) {

  $scope.open = function() {
    $scope.showModal = true;
  $('#test').empty();
	for (var index = emotions.length-1; index >=0; index--) {
		var element = emotions[index];
		 $('#test').append($('<a class="other" onclick="showItem(this)" title="'+element['syntax']+'">').append('<span id="item" class="emotion"><img src="jemotion/emotions/'+emotions[index]['icon']+'" title="'+emotions[index]['title']+'"/></span>'));
	}
  };

  $scope.ok = function() {
    $scope.showModal = false;
	
  };
  
  $scope.clean = function () {
	$('#messages').empty();
  }

});

//show dialog to ask user name
var person = prompt("Please enter your name", "No name");
//default name is Test default
if (person == null) {
      person = "Test default";
 }
//Connect to Node server
//AWS server http://52.68.104.55:8000
var socket = io("http://10.50.100.138:8000");

//send joinchat event
socket.emit('join', {"name" : person});

//handler for list all connected user
socket.on('init', function(data) {
	$('#messages').append($('<li class="join">').append(data + " đang tham gia chat "));
});
	  
//handler for another user exit room
socket.on('exit', function(data) {
	if(data != null) {
		var str = data.name + " đã thoát";
		$('#messages').append($('<li class="join">').append(str)); 
		notifyMe(str);
	 }
});
	  
//handler for another
socket.on('join', function(data) {
	var txt = data.name + " đã tham gia chat ";
	var str = $('<li class="join">').append(txt);
	$('#messages').append(str);
	notifyMe(txt);
});

//Handler for another user messages received from server. Parser content and show 
socket.on('message', function(data) {
	/*console.log(data); 
	window.scrollTo(0,document.body.scrollHeight + 200);
	
	console.log(document.body.scrollHeight);
	console.log(document.body.scrollTop);*/
	var name = data.message.name;
	var str = data.message.text;
	var temp2 = name + " nói: "+ str;
	//console.log(window);
	notifyMe(temp2);
	for (var index = 0; index < emotions.length; index++) {
		do {
		// code...
			str = str.replace(emotions[index]['syntax'],'<span class="emotion"><img src="jemotion/emotions/'+emotions[index]['icon']+'" title="'+emotions[index]['title']+'"/></span>' );
		} while (str.indexOf(emotions[index]['syntax']) != -1);
	}
	//console.log(str);
	//console.log(linkify(str));
	var mess = '<li class="other"><div class="sender-name">'+name + '</div><div class="mesg-content">'+linkify(str)+'</div><div class="time-text">'+data.time+'</div></li>';
	console.log(mess);
	$('#messages').append($(mess));
	window.scrollBy(0,400);
});

socket.on('upload', function(data) {
	console.log("upload data: " + data.upload);
	var a = data.upload.split("<<<")
	var username = a[0];
	var text = a[1].split("~~");
	var str = "";
	if(text[1].indexOf("image") > -1)
	{
		str = '<span class="emotion"><img src="'+text[0]+'"/></span>';
		
	}else {
		var add = 'http://127.0.0.1/mychat/'+text[0].substring(2);
		var filename = text[0].substring(21);
		console.log(filename);
		str = '<a href='+add+' target="_blank">'+filename+'</a>';
		console.log(str);
	}
	$('#messages').append($('<li class="other"> ' + username + ': ').append(str));
	notifyMe(username);
	window.scrollBy(0,400);
});

	  
//handler for input text changing event
function changeFunction() {
	console.log("onchange");
}

function htmlEntities(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}
//function to insert selected emotion syntax to input form
function showItem(ele) {
	var str = $('#m').val() + ele.title;
	$('#m').val(str);
	$('#m').focus();
	$('#closeBtn').click();
}
	
//array to save all notifications
var allNoti = [];
	
//Show notification with content
function notifyMe(data) {
// Let's check if the browser supports notifications
	if (!("Notification" in window)) {
		alert("This browser does not support desktop notification");
	}
	// Let's check whether notification permissions have alredy been granted
	else if (Notification.permission === "granted") {
	// If it's okay let's create a notification
		var notification = new Notification(data);
		allNoti.push(notification);
		if(allNoti.length > 2) {
	 		 allNoti[0].close();
	 		 allNoti.shift();
		}
	}
	// Otherwise, we need to ask the user for permission
	else if (Notification.permission !== 'denied') {
		Notification.requestPermission(function (permission) {
		// If the user accepts, let's create a notification
			if (permission === "granted") {
				var notification = new Notification(data);
				allNoti.push(notification);
			//check the allNoti array length and remove old notification when have 3 or more noti at the same time
				if(allNoti.length > 2) {
			 		 allNoti[0].close();
			 		 allNoti.shift();
				}
			}
		});
	}
}
//Handler for form submit. Get input text content and sendto server S
$('form').submit(function(){
	if(String($('#m').val()).length < 1) {
		return false;
	}
	if(String($('#m').val()) == "(clean)") {
		cleanChatContent();
	}
	
	//socket.emit('message',"<b>"+person + " nói</b>: "+ $('#m').val());
	socket.emit('message', { name: person, text : $('#m').val()})
	
	var str = $('#m').val();
	for (var index = 0; index < emotions.length; index++) {
		do {
		// code...
			str = str.replace(emotions[index]['syntax'],'<span class="emotion"><img src="jemotion/emotions/'+emotions[index]['icon']+'" title="'+emotions[index]['title']+'"/></span>' );
		} while (str.indexOf(emotions[index]['syntax']) != -1); 
	
	}
	$('#messages').append($('<li class="mymsg">').append(linkify(str)));
	window.scrollBy(0,400);
	$('#m').val('');
	
	return false;
});

function cleanChatContent() {
	$('#messages').empty();
	$('#m').val('');
	return false;
}

//document.getElementById('clean').addEventListener("mouseover", cleanChatContent);
var onHide = false;
document.addEventListener("keydown", checkKeyDown, false);
function checkKeyDown(e) {
	var keyCode = e.keyCode;
	if(keyCode == 27) {
		cleanChatContent();
	}
	if(keyCode == 112) {
		if(!onHide) {
			document.getElementById("hide-form").style.visibility="hidden";
			onHide = true;
		}else {
			document.getElementById("hide-form").style.visibility="visible"
			onHide = false;
		}
	}
	if(keyCode == 113) {
		window.location.href ="https://ap-northeast-1.console.aws.amazon.com/ec2/v2/home?region=ap-northeast-1#Instances:sort=instanceId";
	}
}

var uploader = document.getElementById('uploader');
   upclick(
     {
      element: uploader, 
      action: 'upload.php', 
      onstart:
        function(filename)
        {
          //alert('Start upload: '+filename);
        },
      oncomplete:
        function(response_data) 
        {
          console.log(response_data);
		  var data = response_data.split("~~");
		  var str = "";
		  if(data[1].indexOf("image") > -1)
		   {
			   str = '<span class="emotion"><img src="'+data[0]+'"/></span>';
		 	 
		   }else {
			   var add = 'http://127.0.0.1/mychat/'+data[0].substring(2) + '"';
			   var filename = data[0].substring(21);
			   console.log(filename);
			   str = '<a href="'+add+' target="_blank">'+filename+'</a>';
			   console.log(str);
		   }
		   $('#messages').append($('<li class="mymsg" style="border: 2px dashed #aaa">').append(str));
		  	socket.emit('upload',"<b>"+person + " Uploaded</b>:<<<"+ response_data);
        }
     });
	  